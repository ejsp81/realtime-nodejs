extends ../layout

block scripts
    script(src='/socket.io/socket.io.js')

block layout-content

  div
    .container
      br

      form#frmCreate.form-horizontal(method='POST', action='#', accept-charset='UTF-8')
        .row
          .col-xs-12.col-sm-6
            .form-group
              label.control-label(for='local_team') Local
              select#local_team.form-control(name='visitor_team')
          .col-xs-12.col-sm-6
            .form-group
              label.control-label(for='visitor_team') Visitante
              select#visitor_team.form-control(name='visitor_team')
        .row
          .col-xs-12.col-sm-8
            .form-group
              button.btn.btn-primary(name='submit', type='submit', title='Guardar')
                i.fas.fa-save(aria-hidden='true')
                |  Guardar
            
      table#myTable.table
        thead
          tr
            th local_team
            th visitor_team
            th local_goals
            th visitor_goals
            th is_playing
            th current_time
            th 
        tbody
    script.
      getTeams(); 
      getData(); 
      $(function () {
        var socket = io();
        socket.on('changeTournamentResult', function(data){
          $('#myTable tbody tr').remove();
          data.forEach(addRow);
        });

        $('#frmCreate').submit(function(e) {
          e.preventDefault();
          fetch('tournament_results/create', {
            method:  'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify({
              local_team:   $('#local_team').val(), 
              visitor_team: $('#visitor_team').val(),
              local_goals:  0,
              visitor_goals:0,
              is_playing:   true,
              current_time: 0
            })
          });
        });
      });
      function addRow(data){
        $('#myTable > tbody').append(`
          <tr>
          <td>${data.local_team.name}</td>
          <td>${data.visitor_team.name}</td>
          <td>${data.local_goals}</td>
          <td>${data.visitor_goals}</td>
          <td>${data.is_playing}</td>
          <td>${data.current_time}</td>
          <td>
            <a class="btn btn-info btn-sm" href="tournament_results/edit/${data._id}" title="Editar">
              <i class="fas fa-edit" aria-hidden="true"></i>
          </a></td>
          </tr>`);
      }
      function getData(){
        $.get('tournament_results/get', (data) => {
          data.forEach(addRow);
        });
      }
      function getTeams(){
        $.get('/teams/get', (data) => {
          data.forEach(function(team){
            $('#local_team').append(`<option value=${team._id}>${team.name}</option>`)
            $('#visitor_team').append(`<option value=${team._id}>${team.name}</option>`)
          });
        });
      }
    
  hr
  footer
  .container
    div(align='center')
      | Uniajc